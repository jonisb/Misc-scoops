name: Check URL Freshness

on:
  schedule:
    - cron: '0 6 * * *' # Run daily at 6 AM UTC
  workflow_dispatch: # Allow manual triggering

jobs:
  check-url-freshness:
    name: Check URL Freshness
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history needed to get manifest last commit dates

      - name: Check URL freshness
        id: check
        shell: bash
        run: |
          set -euo pipefail

          REPORT_FILE="/tmp/report.md"
          USER_AGENT="Mozilla/5.0 (compatible; ScoopBucketChecker/1.0; +https://github.com/${{ github.repository }})"

          # Initialize report
          {
            echo "# URL Freshness Report"
            echo ""
            echo "Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo ""
          } > "$REPORT_FILE"

          # Use arrays for safe string accumulation
          declare -a UPDATED_ITEMS=()
          declare -a FAILED_ITEMS=()

          # Process each manifest file using nullglob to handle no matches gracefully
          shopt -s nullglob
          for manifest in bucket/*.json; do
            app_name=$(basename "$manifest" .json)

            # Get the last commit date for this manifest file (Unix timestamp)
            manifest_commit_timestamp=$(git log -1 --format="%ct" -- "$manifest")
            manifest_commit_date=$(date -u -d "@$manifest_commit_timestamp" '+%a, %d %b %Y %H:%M:%S GMT')
            echo "Manifest: $app_name (last updated: $manifest_commit_date)"

            # Extract URLs from the manifest using null delimiter for safe reading
            while IFS= read -r -d '' url; do
              if [ -z "$url" ] || [ "$url" = "null" ]; then
                continue
              fi

              # Remove fragment from URL (e.g., #/dl.exe) using bash parameter expansion
              clean_url="${url%%#*}"

              echo "  Checking URL: $clean_url"

              # Get Last-Modified header using HEAD request with user agent and limited redirects
              # Capture curl output and exit code, handling failures gracefully with set -e
              curl_exit_code=0
              response=$(curl -sI -L --max-redirs 5 --max-time 30 -A "$USER_AGENT" "$clean_url" 2>/dev/null) || curl_exit_code=$?
              last_modified=$(echo "$response" | grep -i "^last-modified:" | tail -1 | sed 's/^[Ll]ast-[Mm]odified: *//' | tr -d '\r' || true)

              if [ -z "$last_modified" ]; then
                if [ "$curl_exit_code" -ne 0 ]; then
                  echo "    Warning: Connection failed (curl exit code: $curl_exit_code)"
                  FAILED_ITEMS+=("- **${app_name}**: \`${clean_url}\` (Connection failed, curl exit code: $curl_exit_code)")
                else
                  echo "    Warning: No Last-Modified header found"
                  FAILED_ITEMS+=("- **${app_name}**: \`${clean_url}\` (No Last-Modified header)")
                fi
                continue
              fi

              echo "    Last-Modified: $last_modified"

              # Convert Last-Modified header to Unix timestamp for comparison
              url_timestamp=$(date -u -d "$last_modified" '+%s' 2>/dev/null || echo "0")

              if [ "$url_timestamp" -gt "$manifest_commit_timestamp" ]; then
                echo "    Status: UPDATED! URL modified after manifest was last updated"
                UPDATED_ITEMS+=("- **${app_name}**: \`${clean_url}\`" "  - Manifest last updated: ${manifest_commit_date}" "  - URL Last-Modified: ${last_modified}")
              else
                echo "    Status: OK (URL not modified since manifest update)"
              fi
            done < <(jq -j '
              [
                .url,
                .architecture?.["64bit"]?.url,
                .architecture?.["32bit"]?.url,
                .architecture?.arm64?.url
              ] | map(select(. != null)) | .[] | (. + "\u0000")
            ' "$manifest" 2>/dev/null || true)
          done
          shopt -u nullglob

          # Generate report
          if [ ${#UPDATED_ITEMS[@]} -gt 0 ]; then
            {
              echo "## ⚠️ URLs Updated Since Manifest Change"
              echo ""
              echo "The following URLs have been modified since their manifest was last updated:"
              echo ""
              printf '%s\n' "${UPDATED_ITEMS[@]}"
              echo ""
            } >> "$REPORT_FILE"
            echo "has_updates=true" >> "$GITHUB_OUTPUT"
          else
            {
              echo "## ✅ No Updated URLs"
              echo ""
              echo "All URLs have not been modified since their manifest was last updated."
              echo ""
            } >> "$REPORT_FILE"
            echo "has_updates=false" >> "$GITHUB_OUTPUT"
          fi

          if [ ${#FAILED_ITEMS[@]} -gt 0 ]; then
            {
              echo "## ❌ URLs With Issues"
              echo ""
              echo "The following URLs had issues during checking:"
              echo ""
              printf '%s\n' "${FAILED_ITEMS[@]}"
              echo ""
            } >> "$REPORT_FILE"
          fi

          # Output report to job summary
          cat "$REPORT_FILE" >> "$GITHUB_STEP_SUMMARY"
