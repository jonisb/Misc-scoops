name: Check FFC Version

on:
  schedule:
    - cron: '0 8 * * *' # Run daily at 8 AM UTC
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write

concurrency:
  group: update-ffc-version
  cancel-in-progress: false

jobs:
  check-ffc-version:
    name: Check FFC Version
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check FFC version in archive
        id: check
        shell: bash
        run: |
          set -euo pipefail
          
          MANIFEST_FILE="bucket/ffc.json"
          URL_64BIT="https://www.uwe-sieber.de/files/FFC_x64.zip"
          URL_32BIT="https://www.uwe-sieber.de/files/FFC_Win32.zip"
          USER_AGENT="Mozilla/5.0 (compatible; ScoopBucketChecker/1.0; +https://github.com/${{ github.repository }})"
          
          # Get the last commit timestamp for the manifest file
          manifest_commit_timestamp=$(git log -1 --format="%ct" -- "$MANIFEST_FILE" 2>/dev/null || echo "")
          if [ -z "$manifest_commit_timestamp" ]; then
            echo "Warning: No git history found for manifest, will check version"
            should_check=true
          else
            manifest_commit_date=$(date -u -d "@$manifest_commit_timestamp" '+%a, %d %b %Y %H:%M:%S GMT')
            echo "Manifest last updated: $manifest_commit_date"
            
            # Check Last-Modified header for the 64-bit archive
            echo "Checking Last-Modified header for FFC_x64.zip..."
            response=$(curl -sI -L --max-redirs 5 --max-time 30 -A "$USER_AGENT" "$URL_64BIT" 2>/dev/null || true)
            last_modified=$(echo "$response" | grep -i "^last-modified:" | tail -1 | sed 's/^[Ll]ast-[Mm]odified: *//' | tr -d '\r' || true)
            
            if [ -z "$last_modified" ]; then
              echo "No Last-Modified header found, will check version anyway"
              should_check=true
            else
              echo "URL Last-Modified: $last_modified"
              
              # Convert Last-Modified to Unix timestamp
              url_timestamp=$(date -u -d "$last_modified" '+%s' 2>/dev/null || echo "")
              if [ -z "$url_timestamp" ]; then
                echo "Could not parse Last-Modified header, will check version anyway"
                should_check=true
              elif [ "$url_timestamp" -le "$manifest_commit_timestamp" ]; then
                echo "Archive has not been modified since last manifest update, skipping download"
                should_check=false
              else
                echo "Archive has been modified since last manifest update, will check version"
                should_check=true
              fi
            fi
          fi
          
          if [ "$should_check" = false ]; then
            echo "needs_update=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          # Download the FFC archive
          echo "Downloading FFC_x64.zip..."
          if ! curl -L --fail --show-error -o /tmp/FFC_x64.zip "$URL_64BIT"; then
            echo "Failed to download FFC_x64.zip"
            exit 1
          fi
          
          # Extract and read version from FFC.txt
          echo "Extracting FFC.txt..."
          if ! unzip -q -j /tmp/FFC_x64.zip FFC.txt -d /tmp/; then
            echo "Failed to extract FFC.txt from archive"
            exit 1
          fi
          
          # Extract version from FFC.txt (format: "FFC V1.9.3 - Fast File Copy")
          actual_version=$(grep -oP 'FFC V\K[\d.]+' /tmp/FFC.txt | head -1 || true)
          if [ -z "$actual_version" ]; then
            echo "Failed to extract version from FFC.txt"
            exit 1
          fi
          echo "Actual version in archive: $actual_version"
          
          # Read current version from manifest
          manifest_version=$(jq -r '.version' "$MANIFEST_FILE")
          echo "Manifest version: $manifest_version"
          
          # Compare versions
          if [ "$actual_version" != "$manifest_version" ]; then
            echo "Version mismatch detected! Archive has $actual_version, manifest has $manifest_version"
            echo "needs_update=true" >> "$GITHUB_OUTPUT"
            echo "new_version=$actual_version" >> "$GITHUB_OUTPUT"
            
            # Calculate new hash
            new_hash=$(sha256sum /tmp/FFC_x64.zip | awk '{print $1}')
            echo "new_hash_64bit=$new_hash" >> "$GITHUB_OUTPUT"
            
            # Download and hash 32-bit version
            if ! curl -L --fail --show-error -o /tmp/FFC_Win32.zip "$URL_32BIT"; then
              echo "Failed to download FFC_Win32.zip"
              exit 1
            fi
            new_hash_32=$(sha256sum /tmp/FFC_Win32.zip | awk '{print $1}')
            echo "new_hash_32bit=$new_hash_32" >> "$GITHUB_OUTPUT"
          else
            echo "Versions match, no update needed"
            echo "needs_update=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Update manifest
        if: steps.check.outputs.needs_update == 'true'
        shell: bash
        run: |
          # Update version and hashes in manifest
          jq --arg ver "${{ steps.check.outputs.new_version }}" \
             --arg hash64 "${{ steps.check.outputs.new_hash_64bit }}" \
             --arg hash32 "${{ steps.check.outputs.new_hash_32bit }}" \
             '.version = $ver | .architecture."64bit".hash = $hash64 | .architecture."32bit".hash = $hash32' \
             bucket/ffc.json > bucket/ffc.json.tmp
          mv bucket/ffc.json.tmp bucket/ffc.json
          
          echo "Updated manifest to version ${{ steps.check.outputs.new_version }}"

      - name: Commit and push changes
        if: steps.check.outputs.needs_update == 'true'
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git add bucket/ffc.json
          git commit -m "Auto-update ffc.json to version ${{ steps.check.outputs.new_version }} [skip ci]"
          git push

      - name: Summary
        shell: bash
        run: |
          if [ "${{ steps.check.outputs.needs_update }}" = "true" ]; then
            echo "✅ FFC manifest updated to version ${{ steps.check.outputs.new_version }}" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "✅ FFC manifest is up to date" >> "$GITHUB_STEP_SUMMARY"
          fi
