name: Test Install/Uninstall

on:
  pull_request:
    branches:
      - master
    paths:
      - 'bucket/*.json'

jobs:
  test-install:
    name: Test Install/Uninstall
    runs-on: windows-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@main
        with:
          fetch-depth: 0

      - name: Get changed manifests
        id: changed
        shell: bash
        run: |
          # Get list of changed manifest files
          changed_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} -- 'bucket/*.json' | tr '\n' ' ')
          echo "Changed files: $changed_files"
          
          # Extract app names (filename without .json extension)
          apps=""
          for file in $changed_files; do
            if [ -f "$file" ]; then
              app=$(basename "$file" .json)
              apps="$apps $app"
            fi
          done
          apps=$(echo $apps | xargs) # trim whitespace
          echo "apps=$apps" >> $GITHUB_OUTPUT
          echo "Apps to test: $apps"

      - name: Install Scoop
        if: steps.changed.outputs.apps != ''
        shell: powershell
        run: |
          Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
          iex "& {$(irm get.scoop.sh)}"
          echo "$env:USERPROFILE\scoop\shims" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Add test bucket
        if: steps.changed.outputs.apps != ''
        shell: powershell
        run: |
          Write-Output "Adding bucket for testing..."
          $bucketDir = "$env:USERPROFILE\scoop\buckets\test-bucket"
          if (Test-Path $bucketDir) {
            Remove-Item $bucketDir -Force -Recurse
          }
          New-Item -ItemType Junction -Path $bucketDir -Target $PWD -ErrorAction Stop | Out-Null
          
          # Add extras bucket for dependencies
          scoop bucket add extras

      - name: Test install and uninstall
        if: steps.changed.outputs.apps != ''
        shell: powershell
        run: |
          $apps = "${{ steps.changed.outputs.apps }}" -split " "
          $failed = @()
          
          foreach ($app in $apps) {
            if ([string]::IsNullOrWhiteSpace($app)) { continue }
            
            Write-Output ""
            Write-Output "=========================================="
            Write-Output "Testing: $app"
            Write-Output "=========================================="
            
            # Test install
            Write-Output "Installing $app..."
            try {
              scoop install "test-bucket/$app" 2>&1 | Tee-Object -Variable installOutput
              if ($LASTEXITCODE -ne 0) {
                throw "Install failed with exit code $LASTEXITCODE"
              }
              Write-Output "[OK] $app installed successfully"
            } catch {
              Write-Output "[FAIL] $app install failed: $_"
              $failed += "$app (install)"
              continue
            }
            
            # Verify installation
            Write-Output "Verifying $app installation..."
            $info = scoop info $app 2>&1
            if ($LASTEXITCODE -ne 0) {
              Write-Output "[WARN] Could not get info for $app"
            } else {
              Write-Output $info
            }
            
            # Test uninstall
            Write-Output "Uninstalling $app..."
            try {
              scoop uninstall $app 2>&1 | Tee-Object -Variable uninstallOutput
              if ($LASTEXITCODE -ne 0) {
                throw "Uninstall failed with exit code $LASTEXITCODE"
              }
              Write-Output "[OK] $app uninstalled successfully"
            } catch {
              Write-Output "[FAIL] $app uninstall failed: $_"
              $failed += "$app (uninstall)"
            }
          }
          
          Write-Output ""
          Write-Output "=========================================="
          Write-Output "Summary"
          Write-Output "=========================================="
          
          if ($failed.Count -gt 0) {
            Write-Error "Failed tests: $($failed -join ', ')"
            exit 1
          }
          
          Write-Output "All install/uninstall tests passed!"
