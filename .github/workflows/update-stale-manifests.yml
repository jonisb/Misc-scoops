name: Update Stale Manifests

on:
  workflow_dispatch:
    inputs:
      apps:
        description: 'Space-separated list of manifests to refresh (e.g. "indiegala-gog")'
        required: true
        default: indiegala-gog

permissions:
  contents: write

jobs:
  update:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Scoop
        shell: powershell
        run: |
          Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
          $scoopInstaller = Join-Path $env:TEMP 'install-scoop.ps1'
          irm https://get.scoop.sh -OutFile $scoopInstaller
          & $scoopInstaller
          "$env:USERPROFILE\scoop\shims" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Add bucket
        shell: powershell
        run: |
          $bucketDir = "$env:USERPROFILE\scoop\buckets\misc-scoops"
          if (Test-Path $bucketDir) {
              Remove-Item $bucketDir -Force -Recurse
          }
          New-Item -ItemType Junction -Path $bucketDir -Target $env:GITHUB_WORKSPACE | Out-Null

      - name: Refresh hashes
        shell: powershell
        run: |
          $apps = "${{ github.event.inputs.apps }}".Split(' ', [System.StringSplitOptions]::RemoveEmptyEntries)
          if ($apps.Count -eq 0) {
              Write-Output "No apps specified. Skipping."
              exit 0
          }

          $bucketPath = $env:GITHUB_WORKSPACE
          $checkhashesScript = "$env:USERPROFILE\scoop\apps\scoop\current\bin\checkhashes.ps1"

          if (-not (Test-Path $checkhashesScript)) {
              throw "checkhashes script not found at $checkhashesScript"
          }

          foreach ($app in $apps) {
              Write-Output "`n=========================================="
              Write-Output "Updating: $app"
              Write-Output "=========================================="
              $output = & $checkhashesScript -App $app -Dir $bucketPath -Update *>&1
              $lastExitCode = $LASTEXITCODE
              if ($null -eq $lastExitCode) {
                  Write-Output "checkhashes returned no exit code; assuming success"
                  $exitCode = 0
              } else {
                  $exitCode = [int] $lastExitCode
              }
              $output | ForEach-Object { Write-Output $_ }

              if ($exitCode -gt 0) {
                  throw "checkhashes failed for $app (exit code $exitCode)"
              }
          }

      - name: Commit changes
        shell: powershell
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          $apps = "${{ github.event.inputs.apps }}".Split(' ', [System.StringSplitOptions]::RemoveEmptyEntries)
          $commitMessage = "Refresh stale manifest(s)"
          if ($apps.Count -gt 0) {
              $commitMessage = "$commitMessage: $($apps -join ', ')"
          }

          $changes = git status --porcelain
          if (-not [string]::IsNullOrWhiteSpace($changes)) {
              git add bucket
              git commit -m "$commitMessage"
              git push
          } else {
              Write-Output "No manifest updates produced."
          }
