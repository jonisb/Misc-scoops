on:
  push:
    branches:
    - master
  pull_request:
    branches:
    - master
name: Test Manifests
jobs:
  test:
    name: Test Manifests
    runs-on: windows-latest
    permissions:
      contents: read
    steps:
    - name: Checkout
      uses: actions/checkout@main
    - name: Install Scoop
      shell: powershell
      run: |
        Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
        iex "& {$(irm get.scoop.sh)}"
        echo "$env:USERPROFILE\scoop\shims" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
    - name: Test Manifests with Scoop
      shell: powershell
      run: |
        Write-Output "PowerShell: $($PSVersionTable.PSVersion)"
        Write-Output ""
        Write-Output "Adding bucket for testing..."
        scoop bucket add test-bucket $PWD
        Write-Output ""
        Write-Output "Testing all manifests in bucket..."
        $bucketPath = Join-Path $PWD "bucket"
        $manifests = Get-ChildItem $bucketPath -Filter '*.json'
        $failed = @()
        foreach ($manifest in $manifests) {
          $appName = [System.IO.Path]::GetFileNameWithoutExtension($manifest.Name)
          Write-Output "Testing manifest: $appName"
          try {
            $json = Get-Content $manifest.FullName -Raw | ConvertFrom-Json -ErrorAction Stop
            if (-not $json.version) {
              throw "Missing 'version' field"
            }
            if (-not $json.url -and -not $json.architecture) {
              throw "Missing 'url' or 'architecture' field"
            }
            $info = scoop info $appName 2>&1
            if ($LASTEXITCODE -ne 0) {
              throw "scoop info failed: $info"
            }
            Write-Output "  [OK] $appName is valid"
          } catch {
            Write-Output "  [FAIL] $appName failed: $_"
            $failed += $appName
          }
        }
        Write-Output ""
        if ($failed.Count -gt 0) {
          Write-Error "Failed manifests: $($failed -join ', ')"
          exit 1
        }
        Write-Output "All $($manifests.Count) manifests passed validation"
